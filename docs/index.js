const noSleep=new NoSleep,tmpCanvas=document.createElement("canvas"),bgm=new Audio("mp3/bgm.mp3");bgm.volume=.5;const sound=new Audio;let timerInterval,vibrateInterval,duration=0,startTime,remainingTime;loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark"),localStorage.getItem("bgm")!=1&&(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none")),localStorage.getItem("noSleep")==1&&(document.getElementById("noSleepOn").classList.remove("d-none"),document.getElementById("noSleepOff").classList.add("d-none"),document.addEventListener("pointerdown",()=>{noSleep.enable()},{once:!0}))}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function toggleTimer(){timerInterval?stopTimer():startTimer()}function stopTimer(){timerInterval=clearInterval(timerInterval),bgm.pause(),sound.pause(),vibrateInterval&&clearInterval(vibrateInterval);const e=document.getElementById("startButton");e.textContent="スタート"}function startTimer(){if(sound.src="mp3/"+document.getElementById("changeSound").value+".mp3",!isNaN(duration)&&duration>0){const e=document.getElementById("startButton");e.textContent="ストップ",remainingTime!=0?startTime=Date.now()-duration+remainingTime:startTime=Date.now(),timerInterval=setInterval(tick,200)}}function resetTimer(){timerInterval&&clearInterval(timerInterval),bgm.pause(),sound.pause(),vibrateInterval&&clearInterval(vibrateInterval),remainingTime=0;const e=document.getElementById("startButton");e.textContent="スタート",e.onclick=startTimer;const t=document.getElementById("timerText"),n=document.getElementById("timerValue"),s=parseInt(n.value);duration=s*6e4,isNaN(duration)||duration<0?duration=0:999<s&&(n.value=999,duration=999*6e4);const o=Math.floor(duration/6e4),i=Math.floor(Math.abs(duration)%6e4/1e3);t.textContent=o+":"+("0"+i).slice(-2),resizeFontSize(t)}function tick(){const t=document.getElementById("timerText");let e;remainingTime=startTime+duration-Date.now(),remainingTime<0?(bgm.pause(),remainingTime<-3e5?(sound.pause(),clearInterval(vibrateInterval)):sound.src.includes("none.mp3")?vibrateInterval||(vibrateInterval=setInterval(()=>{navigator.vibrate(400)},400)):sound.play(),e=Math.ceil(remainingTime/6e4),e==0&&(e="-0")):(localStorage.getItem("bgm")==1&&(bgm.loop=!0,bgm.play()),e=Math.floor(remainingTime/6e4));const n=Math.floor(Math.abs(remainingTime)%6e4/1e3);t.textContent=e+":"+("0"+n).slice(-2)}function changeSound(){sound.src="mp3/"+document.getElementById("changeSound").value+".mp3"}function resizeFontSize(e){function c(e,t){const n=tmpCanvas.getContext("2d");n.font=t;const s=n.measureText(e);return s.width}function l(e,t,n,s){const o=e.split(`
`),a=t+"px "+n;let i=0;for(let e=0;e<o.length;e++){const t=c(o[e],a);i<t&&(i=t)}return[i,t*o.length*s]}function d(e){const t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),n=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom);return[t,n]}const t=getComputedStyle(e),u=t.fontFamily,n=parseFloat(t.fontSize),h=parseFloat(t.lineHeight)/n,s=[e.parentNode.offsetWidth,e.parentNode.offsetHeight],o=l(e.textContent,n,u,h),i=d(t),a=n*(s[0]-i[0])/o[0]*.9,r=n*(s[1]-i[1])/o[1]*.9;r<a?e.style.fontSize=r+"px":e.style.fontSize=a+"px"}function toggleNoSleep(){localStorage.getItem("noSleep")==1?(document.getElementById("noSleepOn").classList.add("d-none"),document.getElementById("noSleepOff").classList.remove("d-none"),localStorage.setItem("noSleep",0),noSleep.disable()):(document.getElementById("noSleepOn").classList.remove("d-none"),document.getElementById("noSleepOff").classList.add("d-none"),localStorage.setItem("noSleep",1),noSleep.enable())}function toggleBGM(){localStorage.getItem("bgm")==1?(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"),localStorage.setItem("bgm",0),bgm.pause()):(document.getElementById("bgmOn").classList.remove("d-none"),document.getElementById("bgmOff").classList.add("d-none"),localStorage.setItem("bgm",1),bgm.loop=!1,bgm.play())}const timerText=document.getElementById("timerText");resizeFontSize(timerText),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toggleBGM").onclick=toggleBGM,document.getElementById("toggleNoSleep").onclick=toggleNoSleep,document.getElementById("resetTimer").onclick=resetTimer,document.getElementById("timerValue").onchange=resetTimer,document.getElementById("changeSound").onchange=changeSound,document.getElementById("startButton").onclick=toggleTimer,timerText.parentNode.onclick=toggleTimer,globalThis.addEventListener("resize",()=>{resizeFontSize(timerText)})