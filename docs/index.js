const noSleep=new NoSleep,tmpCanvas=document.createElement("canvas"),bgm=new Audio("mp3/bgm.mp3");bgm.volume=.5;const sound=new Audio;let timerInterval,vibrateInterval,duration=0,startTime,remainingTime;loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark"),localStorage.getItem("bgm")!=1&&(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none")),localStorage.getItem("noSleep")!=1&&(document.getElementById("noSleepOn").classList.add("d-none"),document.getElementById("noSleepOff").classList.remove("d-none"))}function stopTimer(){clearInterval(timerInterval),bgm.pause(),sound.pause(),vibrateInterval&&clearInterval(vibrateInterval);const a=document.getElementById("startButton");a.textContent="スタート",a.onclick=startTimer}function startTimer(){if(sound.src="mp3/"+document.getElementById("changeSound").value+".mp3",!isNaN(duration)&&duration>0){const a=document.getElementById("startButton");a.textContent="ストップ",a.onclick=stopTimer,remainingTime!=0?startTime=Date.now()-duration+remainingTime:startTime=Date.now(),timerInterval=setInterval(tick,200)}}function resetTimer(){timerInterval&&clearInterval(timerInterval),bgm.pause(),sound.pause(),vibrateInterval&&clearInterval(vibrateInterval),remainingTime=0;const a=document.getElementById("startButton");a.textContent="スタート",a.onclick=startTimer;const b=document.getElementById("timerText"),c=document.getElementById("timerValue"),d=parseInt(c.value);duration=d*6e4,isNaN(duration)||duration<0?duration=0:999<d&&(c.value=999,duration=999*6e4);const e=Math.floor(duration/6e4),f=Math.floor(Math.abs(duration)%6e4/1e3);b.textContent=e+":"+("0"+f).slice(-2),resizeFontSize(b)}function tick(){const b=document.getElementById("timerText");let a;remainingTime=startTime+duration-Date.now(),remainingTime<0?(bgm.pause(),remainingTime<-3e5?(sound.pause(),clearInterval(vibrateInterval)):sound.src.includes("none.mp3")?vibrateInterval||(vibrateInterval=setInterval(()=>{navigator.vibrate(400)},400)):sound.play(),a=Math.ceil(remainingTime/6e4),a==0&&(a="-0")):(localStorage.getItem("bgm")==1&&(bgm.loop=!0,bgm.play()),a=Math.floor(remainingTime/6e4));const c=Math.floor(Math.abs(remainingTime)%6e4/1e3);b.textContent=a+":"+("0"+c).slice(-2)}function changeSound(){sound.src="mp3/"+document.getElementById("changeSound").value+".mp3"}function resizeFontSize(a){function m(b,c){const a=tmpCanvas.getContext("2d");a.font=c;const d=a.measureText(b);return d.width}function k(g,c,d,e){const b=g.split("\n"),f=c+"px "+d;let a=0;for(let c=0;c<b.length;c++){const d=m(b[c],f);a<d&&(a=d)}return[a,c*b.length*e]}function j(a){const b=parseFloat(a.paddingLeft)+parseFloat(a.paddingRight),c=parseFloat(a.paddingTop)+parseFloat(a.paddingBottom);return[b,c]}const b=getComputedStyle(a),l=b.fontFamily,c=parseFloat(b.fontSize),i=parseFloat(b.lineHeight)/c,h=[a.parentNode.offsetWidth,a.parentNode.offsetHeight],d=k(a.textContent,c,l,i),e=j(b),f=c*(h[0]-e[0])/d[0]*.9,g=c*(h[1]-e[1])/d[1]*.9;g<f?a.style.fontSize=g+"px":a.style.fontSize=f+"px"}function toggleNoSleep(){localStorage.getItem("noSleep")==1?(document.getElementById("noSleepOn").classList.add("d-none"),document.getElementById("noSleepOff").classList.remove("d-none"),localStorage.setItem("noSleep",0),noSleep.disable()):(document.getElementById("noSleepOn").classList.remove("d-none"),document.getElementById("noSleepOff").classList.add("d-none"),localStorage.setItem("noSleep",1),noSleep.enable())}function toggleBGM(){localStorage.getItem("bgm")==1?(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"),localStorage.setItem("bgm",0),bgm.pause()):(document.getElementById("bgmOn").classList.remove("d-none"),document.getElementById("bgmOff").classList.add("d-none"),localStorage.setItem("bgm",1),bgm.loop=!1,bgm.play())}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}const timerText=document.getElementById("timerText");resizeFontSize(timerText),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("toggleBGM").onclick=toggleBGM,document.getElementById("toggleNoSleep").onclick=toggleNoSleep,document.getElementById("resetTimer").onclick=resetTimer,document.getElementById("timerValue").onchange=resetTimer,document.getElementById("changeSound").onchange=changeSound,document.getElementById("startButton").onclick=startTimer,window.addEventListener("resize",()=>{resizeFontSize(timerText)})